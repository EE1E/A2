; WRITTEN BY            Ahmad Khattab
; DATE                  05/02/2014
; FILE SAVED AS         TEST.ASM
; DEVICE                PIC16F84
; OSCILLATOR            XT (4MHZ)
; WATCHDOG              DISABLED
; CODE PROTECT          OFF
; FUNCTION              OUTPUTS THE VALUE 0XF1 TO LEDS CONNECTED TO PORTB
;                       
; -----------------------   EQUATES    ------------------------------------
PORTB   EQU     0X06    ;ASSIGN THE PORTB REGISTER TO THE LABEL 'PORTB'
PORTA	EQU		0X05
MCOUNT 	EQU 	0x0C
NCOUNT 	EQU 	0x0D
RED		EQU		0X01	;RED LED ON PIN 1 OM PORTB
AMBER	EQU		0X02
GREEN	EQU		0X03
COUNT	EQU		0X0E	;TEMP VARIABLE TO COUNT HOW MANY TIMES LOOP WAS RAN
PR		EQU		0X04	;PEDESTRIAN RED
PG		EQU		0X05	;PEDESTRIAN GREEN
INTCON	EQU		0X0B	
RBIF	EQU		0X00
GIE		EQU		0X07
RBIE	EQU		0X03
TCOUNT	EQU		0X0F	;TEMP VARIABLES FOR CONTEXT SAVING
TMCOUNT	EQU		0X10	;TEMP VARIABLES FOR CONTEXT SAVING
TNCOUNT	EQU		0X11	;TEMP VARIABLES FOR CONTEXT SAVING

; ----------------------- MAIN PROGRAM ------------------------------------
        ORG     0X00    ;'ORG' SPECIFIES THE MEMORY LOCATION OF THE PROGRAM
		GOTO	START

		ORG	 	0X04
		GOTO	INT_SER

INT_SER		;INTERRUPT SERVICE ROUTINE
		MOVF	COUNT,1 ;MOVES THE VARIABLES TO A TEMP VARIABLE, CONTEXT SAVING
		MOVWF	TCOUNT		
		MOVF	MCOUNT,1 ;MOVES THE VARIABLES TO A TEMP VARIABLE,
		MOVWF	TMCOUNT
		MOVF	NCOUNT,1 ;MOVES THE VARIABLES TO A TEMP VARIABLE,
		MOVWF	TNCOUNT
				
		BCF 	PORTB,PR ;TURN OFF RED LIGHT
		BSF 	PORTB,PG ;TURN ON GREEN LIGHT
		CALL 	DELAY
		BCF		PORTB,PG	;TURN OFF GREEN LIGHT
		BSF		PORTB,PR	; TURN BACK ON RED LIGHT
		BCF 	INTCON,RBIF	;CLEAR INTERRUPT FLAG IN INTCON
		
		
		MOVF	TCOUNT,0 ;MOVES THE VARIABLES TO A TEMP VARIABLE, CONTEXT SAVING
		MOVWF	COUNT		
		MOVF	TMCOUNT,0 ;MOVES THE VARIABLES TO A TEMP VARIABLE,
		MOVWF	MCOUNT
		MOVF	TNCOUNT,0 ;MOVES THE VARIABLES TO A TEMP VARIABLE,
		MOVWF	NCOUNT
		

		
		RETFIE
	


START	
		MOVLW   B'11000000' ;WE HAVE TWO BUTTONS WHICH WILL GO TO IN 6 AND 7 THE REST OF PINS ARE OUTPUTS
        TRIS    PORTB   ;CONFIGURE PORTB WITH THE VALUE IN W (THE
                        ;WORKING REGISTER) 1=INPUT AND 0=OUTPUT.  
                        ;SO 00 (ALL 0'S) MAKES ALL PORTB LINES OUTPUTS.
        CLRF    PORTB   ;CLEAR THE PORTB REGISTER
		BSF 	PORTB, PR 	;TURNS ON THE RED PEDESTIAN LED
		BSF		INTCON,GIE	;ENABLES THE INTERRUPT
		BSF		INTCON,RBIE


REDL    BSF		PORTB,RED	;turn on red light then delay
		CALL	DELAY		
		BCF		PORTB,RED	;turn off red light then delay
		CALL 	DELAY
AMBERF	CALL	AFLASH		;calls subroutine to flash the amber led 3 times
GREENL	BSF		PORTB,GREEN	;turns on green led then runs a delay
		CALL	DELAY
		BCF		PORTB,GREEN	;turns off green led then runs delay
		CALL 	DELAY	
AMBERL 	BSF 	PORTB,AMBER
		CALL 	DELAY
		BCF 	PORTB,AMBER
		CALL 	DELAY

	
		
    	GOTO    REDL



DELAY	MOVLW	0X05	;does this delay of 0.2 seconds five times, so a delay of 1 second
		MOVWF	COUNT
DSTART	MOVLW 	0XFF	; RUNS A DELAY  of 255*255*3 micro seconds
		MOVWF 	MCOUNT
GET_N	MOVLW 	0XFF
		MOVWF 	NCOUNT
DEC_N 	DECFSZ 	NCOUNT,F
		GOTO 	DEC_N
		DECFSZ 	MCOUNT,F
		GOTO 	GET_N
		DECFSZ	COUNT,1
		GOTO	DSTART
		RETURN

SDELAY	MOVLW 	0XFF	; RUNS A small DELAY of 0.2 seconds
		MOVWF 	MCOUNT
GET_S	MOVLW 	0XFF
		MOVWF 	NCOUNT
DEC_S 	DECFSZ 	NCOUNT,F
		GOTO 	DEC_S
		DECFSZ 	MCOUNT,F
		GOTO 	GET_S
		RETURN

AFLASH	MOVLW	0X03		; flashes the amber light three times
		MOVWF	COUNT
ASTART	BSF		PORTB,AMBER
		CALL	SDELAY
		BCF		PORTB,AMBER
		CALL 	SDELAY
		DECFSZ	COUNT,1
		GOTO	ASTART
		RETURN

        END

