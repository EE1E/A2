; WRITTEN BY            Ahmad Khattab
; DATE                  05/02/2014
; FILE SAVED AS         TEST.ASM
; DEVICE                PIC16F84
; OSCILLATOR            XT (4MHZ)
; WATCHDOG              DISABLED
; CODE PROTECT          OFF
; FUNCTION              TRAFFIC LIGHTS
; OUTPUTS ALL ON PORT B: BUZZER=0, RED=1, AMBER=2, GREEN=3, PASSENGER RED=4, PASSENGER GREEN=5, 
; 						6+7 WILL BE THE BUTTONS ON BOTH SIDES OF THE ROAD
;                       
; -----------------------   EQUATES    ------------------------------------
PORTB   EQU     0X06    ;ASSIGN THE PORTB REGISTER TO THE LABEL 'PORTB'
PORTA	EQU		0X05
MCOUNT 	EQU 	0x0C
NCOUNT 	EQU 	0x0D
RED		EQU		0X01	;RED LED ON PIN 1 OM PORTB
AMBER	EQU		0X02
GREEN	EQU		0X03
PR		EQU		0X04	;PEDESTRIAN RED
PG		EQU		0X05	;PEDESTRIAN GREEN
INTCON	EQU		0X0B	
RBIF	EQU		0X00
GIE		EQU		0X07
RBIE	EQU		0X03
TCOUNT	EQU		0X0F	;TEMP VARIABLES FOR CONTEXT SAVING
TMCOUNT	EQU		0X10	;TEMP VARIABLES FOR CONTEXT SAVING
TNCOUNT	EQU		0X11	;TEMP VARIABLES FOR CONTEXT SAVING
ACOUNT	EQU		0X12	;COUNTER FOR FLASHING AMBER LED
BCOUNT	EQU		0X13	;COUNTER FOR SWITCHING THE BUZZER
DEL_ARG EQU		0X014	;REGISTER HOLDING AN ARGUMENT FOR DELAY FUNCTION

; ----------------------- MAIN PROGRAM ------------------------------------
        ORG     0X00    ;'ORG' SPECIFIES THE MEMORY LOCATION OF THE PROGRAM
		GOTO	START

		ORG	 	0X04
		GOTO	INT_SER

INT_SER		;INTERRUPT SERVICE ROUTINE
		BSF		PORTA,0	;TURN ON WAIT LIGHT
		MOVLW	0X15
		MOVWF	DEL_ARG
		CALL	DELAY	;WAIT 3 SECONDS
		
		MOVLW 	B'00010100' 	;TURNS ON THE RED PEDESTIAN LED AND THE AMBER TRAFFIC LED 
		MOVWF	PORTB
		MOVLW	0X15
		MOVWF	DEL_ARG
		CALL	DELAY
		MOVLW 	B'00010010' 	;TURNS ON THE RED PEDESTIAN LED AND THE RED TRAFFIC LED 
		MOVWF	PORTB
		MOVLW	0X15
		MOVWF	DEL_ARG
		CALL	DELAY
		BCF		PORTA,0	;TURNS OFF WAIT LIGHT
		MOVLW 	B'00100010' 	;TURNS ON THE GREEN PEDESTIAN LED AND THE RED TRAFFIC LED
		MOVWF	PORTB 
		CALL	BFLASH		
		CALL	AFLASH
		MOVLW	0X02
		MOVWF	DEL_ARG		;FLASHES AMBER LED AND PASSENGER GREEN AT THE SAME TIME
		CALL	DELAY
		
		MOVLW 	B'00011000' 	;TURNS ON THE RED PEDESTIAN LED AND THE GREEN TRAFFIC LED (DEFAULT STATE)
		MOVWF	PORTB

		BCF 	INTCON,RBIF	;CLEAR INTERRUPT FLAG IN INTCON
				
		RETFIE
	


START	
		MOVLW   B'11000000' ;WE HAVE TWO BUTTONS WHICH WILL GO TO IN 6 AND 7 THE REST OF PINS ARE OUTPUTS
        TRIS    PORTB   ;CONFIGURE PORTB WITH THE VALUE IN W (THE
                        ;WORKING REGISTER) 1=INPUT AND 0=OUTPUT.  
                        ;SO 00 (ALL 0'S) MAKES ALL PORTB LINES OUTPUTS.
        CLRF    PORTB   ;CLEAR THE PORTB REGISTER
		CLRF	PORTA
		MOVLW 	0X00
		TRIS	PORTA	;MAKE PORT A OUTPUTS		

		BSF		INTCON,GIE	;ENABLES THE INTERRUPT
		BSF		INTCON,RBIE
		MOVLW 	B'00011000' 	;TURNS ON THE RED PEDESTIAN LED AND THE GREEN TRAFFIC LED (DEFAULT STATE)
		MOVWF	PORTB		
LOOP   	GOTO    LOOP



DELAY
DSTART3	MOVLW 	0XFF	; RUNS A DELAY  of 255*255*3 micro seconds
		MOVWF 	MCOUNT
GET_N3	MOVLW 	0XFF
		MOVWF 	NCOUNT
DEC_N3 	DECFSZ 	NCOUNT,F
		GOTO 	DEC_N3
		DECFSZ 	MCOUNT,F
		GOTO 	GET_N3
		DECFSZ	DEL_ARG,1
		GOTO	DSTART3
		RETURN



BFLASH	MOVLW	0X28	;buzzer runs 20 times and acts as a delay of 8 seconds
		MOVWF	BCOUNT
BSTART	MOVLW 	B'00100011' 	;TURNS ON THE RED PEDESTIAN LED AND THE GREEN TRAFFIC LED AND BUZZER
		MOVWF	PORTB 
		MOVLW	0X01
		MOVWF	DEL_ARG
		CALL	DELAY
		MOVLW 	B'00100010' 	;TURNS OFF BUZZER ONLY
		MOVWF	PORTB 
		MOVLW	0X01
		MOVWF	DEL_ARG
		CALL 	DELAY
		DECFSZ	BCOUNT,1
		GOTO	BSTART
		RETURN

AFLASH	MOVLW	0X0A		; flashes the amber LED AND PASSENGER GREEN LED AT THE SAME TIME AND BUZZER 10 times ALSO ACTS AS A DELAY OF 4 SECONDS
		MOVWF	ACOUNT
ASTART	MOVLW 	B'00100101' 	;TURNS ON THE amber LED AND PASSENGER GREEN AND BUZZER
		MOVWF	PORTB 
		MOVLW	0X02
		MOVWF	DEL_ARG
		CALL	DELAY
		CLRF	PORTB
		MOVLW	0X02
		MOVWF	DEL_ARG
		CALL 	DELAY
		DECFSZ	ACOUNT,1
		GOTO	ASTART
		RETURN

        END

